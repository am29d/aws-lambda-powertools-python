
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.7">
    
    
      
        <title>Metrics - AWS Lambda Powertools Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#metrics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="AWS Lambda Powertools Python" class="md-header-nav__button md-logo" aria-label="AWS Lambda Powertools Python">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            AWS Lambda Powertools Python
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Metrics
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AWS Lambda Powertools Python" class="md-nav__button md-logo" aria-label="AWS Lambda Powertools Python">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    AWS Lambda Powertools Python
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Homepage
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
      
      <label class="md-nav__link" for="nav-2">
        Core utilities
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Core utilities" data-md-level="1">
        <label class="md-nav__title" for="nav-2">
          <span class="md-nav__icon md-icon"></span>
          Core utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../tracer/" class="md-nav__link">
        Tracer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../logger/" class="md-nav__link">
        Logger
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Metrics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Metrics
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-utility" class="md-nav__link">
    Core utility
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialization" class="md-nav__link">
    Initialization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-metrics" class="md-nav__link">
    Creating metrics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-metric-with-a-different-dimension" class="md-nav__link">
    Creating a metric with a different dimension
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-metadata" class="md-nav__link">
    Adding metadata
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flushing-metrics" class="md-nav__link">
    Flushing metrics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flushing-metrics-manually" class="md-nav__link">
    Flushing metrics manually
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capturing-cold-start-metric" class="md-nav__link">
    Capturing cold start metric
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-your-code" class="md-nav__link">
    Testing your code
  </a>
  
    <nav class="md-nav" aria-label="Testing your code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    Environment variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clearing-metrics" class="md-nav__link">
    Clearing metrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
      
      <label class="md-nav__link" for="nav-3">
        Utilities
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Utilities" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          Utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/middleware_factory/" class="md-nav__link">
        Middleware factory
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/parameters/" class="md-nav__link">
        Parameters
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/batch/" class="md-nav__link">
        SQS Batch Processing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/typing/" class="md-nav__link">
        Typing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/validation/" class="md-nav__link">
        Validation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/data_classes/" class="md-nav__link">
        Event Source Data Classes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/parser/" class="md-nav__link">
        Parser
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-utility" class="md-nav__link">
    Core utility
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialization" class="md-nav__link">
    Initialization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-metrics" class="md-nav__link">
    Creating metrics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-metric-with-a-different-dimension" class="md-nav__link">
    Creating a metric with a different dimension
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-metadata" class="md-nav__link">
    Adding metadata
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flushing-metrics" class="md-nav__link">
    Flushing metrics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flushing-metrics-manually" class="md-nav__link">
    Flushing metrics manually
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capturing-cold-start-metric" class="md-nav__link">
    Capturing cold start metric
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-your-code" class="md-nav__link">
    Testing your code
  </a>
  
    <nav class="md-nav" aria-label="Testing your code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    Environment variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clearing-metrics" class="md-nav__link">
    Clearing metrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="metrics">Metrics</h1>
<h2 id="core-utility">Core utility</h2>
<p>Metrics creates custom metrics asynchronously by logging metrics to standard output following Amazon CloudWatch Embedded Metric Format (EMF).</p>
<p>These metrics can be visualized through <a href="https://console.aws.amazon.com/cloudwatch/">Amazon CloudWatch Console</a>.</p>
<p><strong>Key features</strong></p>
<ul>
<li>Aggregate up to 100 metrics using a single CloudWatch EMF object (large JSON blob)</li>
<li>Validate against common metric definitions mistakes (metric unit, values, max dimensions, max metrics, etc)</li>
<li>Metrics are created asynchronously by CloudWatch service, no custom stacks needed</li>
<li>Context manager to create an one off metric with a different dimension</li>
</ul>
<h2 id="initialization">Initialization</h2>
<p>Set <code>POWERTOOLS_SERVICE_NAME</code> and <code>POWERTOOLS_METRICS_NAMESPACE</code> env vars as a start - Here is an example using AWS Serverless Application Model (SAM)</p>
<div class="tabbed-set" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">template.yml</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">Resources</span><span class="p">:</span>
    <span class="nt">HelloWorldFunction</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
        <span class="nt">Properties</span><span class="p">:</span>
        <span class="l l-Scalar l-Scalar-Plain">...</span>
        <span class="nt">Runtime</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python3.8</span>
        <span class="nt">Environment</span><span class="p">:</span>
            <span class="nt">Variables</span><span class="p">:</span>
<span class="hll">                <span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">payment</span>
</span><span class="hll">                <span class="nt">POWERTOOLS_METRICS_NAMESPACE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ServerlessAirline</span>
</span></code></pre></div>
</td></tr></table>
</div>
</div>
<p>We recommend you use your application or main service as a metric namespace.
You can explicitly set a namespace name via <code>namespace</code> param or via <code>POWERTOOLS_METRICS_NAMESPACE</code> env var.</p>
<p>This sets <strong>namespace</strong> key that will be used for all metrics.
You can also pass a service name via <code>service</code> param or <code>POWERTOOLS_SERVICE_NAME</code> env var. This will create a dimension with the service name.</p>
<div class="tabbed-set" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">app.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>

<span class="c1"># POWERTOOLS_METRICS_NAMESPACE and POWERTOOLS_SERVICE_NAME defined</span>
<span class="hll"><span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">()</span> <span class="c1"># highlight-line</span>
</span>
<span class="c1"># Explicit definition</span>
<span class="n">Metrics</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;ServerlessAirline&quot;</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;orders&quot;</span><span class="p">)</span>  <span class="c1"># creates a default dimension {&quot;service&quot;: &quot;orders&quot;} under the namespace &quot;ServerlessAirline&quot;</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>You can initialize Metrics anywhere in your code as many times as you need - It'll keep track of your aggregate metrics in memory.</p>
<h2 id="creating-metrics">Creating metrics</h2>
<p>You can create metrics using <code>add_metric</code>, and manually create dimensions for all your aggregate metrics using <code>add_dimension</code>.</p>
<div class="tabbed-set" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><label for="__tabbed_3_1">app.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;ExampleApplication&quot;</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;booking&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">metrics</span><span class="o">.</span><span class="n">add_dimension</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;environment&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;prod&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;SuccessfulBooking&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">MetricUnit</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
</td></tr></table>
</div>
</div>
<p><code>MetricUnit</code> enum facilitate finding a supported metric unit by CloudWatch. Alternatively, you can pass the value as a string if you already know them e.g. "Count".</p>
<p>CloudWatch EMF supports a max of 100 metrics. Metrics utility will flush all metrics when adding the 100th metric while subsequent metrics will be aggregated into a new EMF object, for your convenience.</p>
<h2 id="creating-a-metric-with-a-different-dimension">Creating a metric with a different dimension</h2>
<p>CloudWatch EMF uses the same dimensions across all your metrics. Use <code>single_metric</code> if you have a metric that should have different dimensions.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Generally, this would be an edge case since you <a href="https://aws.amazon.com/cloudwatch/pricing/&quot;">pay for unique metric</a>. Keep the following formula in mind:</p>
<p><strong>unique metric = (metric_name + dimension_name + dimension_value)</strong></p>
</div>
<div class="tabbed-set" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><label for="__tabbed_4_1">single_metric.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">single_metric</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>

<span class="hll"><span class="k">with</span> <span class="n">single_metric</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ColdStart&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">MetricUnit</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;ExampleApplication&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">metric</span><span class="p">:</span> <span class="c1"># highlight-line</span>
</span>    <span class="n">metric</span><span class="o">.</span><span class="n">add_dimension</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;function_context&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;$LATEST&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h2 id="adding-metadata">Adding metadata</h2>
<p>You can use <code>add_metadata</code> for advanced use cases, where you want to metadata as part of the serialized metrics object.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><strong>This will not be available during metrics visualization</strong> - Use <strong>dimensions</strong> for this purpose</p>
</div>
<div class="tabbed-set" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><label for="__tabbed_5_1">app.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;ExampleApplication&quot;</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;booking&quot;</span><span class="p">)</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;SuccessfulBooking&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">MetricUnit</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="hll"><span class="n">metrics</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;booking_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;booking_uuid&quot;</span><span class="p">)</span>
</span></code></pre></div>
</td></tr></table>
</div>
</div>
<p>This will be available in CloudWatch Logs to ease operations on high cardinal data.</p>
<details class="example"><summary>Excerpt output in CloudWatch Logs</summary><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;SuccessfulBooking&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="nt">&quot;_aws&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;Timestamp&quot;</span><span class="p">:</span> <span class="mi">1592234975665</span><span class="p">,</span>
        <span class="nt">&quot;CloudWatchMetrics&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;Namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;ExampleApplication&quot;</span><span class="p">,</span>
                <span class="nt">&quot;Dimensions&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;service&quot;</span>
                    <span class="p">]</span>
                <span class="p">],</span>
                <span class="nt">&quot;Metrics&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;SuccessfulBooking&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;Unit&quot;</span><span class="p">:</span> <span class="s2">&quot;Count&quot;</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;service&quot;</span><span class="p">:</span> <span class="s2">&quot;booking&quot;</span><span class="p">,</span>
<span class="hll">    <span class="nt">&quot;booking_id&quot;</span><span class="p">:</span> <span class="s2">&quot;booking_uuid&quot;</span>
</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</details>
<h2 id="flushing-metrics">Flushing metrics</h2>
<p>As you finish adding all your metrics, you need to serialize and flush them to standard output. You can do that right before you return your response to the caller via <code>log_metrics</code>.</p>
<div class="tabbed-set" data-tabs="6:1"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><label for="__tabbed_6_1">lambda_handler.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="s2">&quot;ExampleService&quot;</span><span class="p">)</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ColdStart&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="hll"><span class="nd">@metrics</span><span class="o">.</span><span class="n">log_metrics</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">add_dimension</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;service&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;booking&quot;</span><span class="p">)</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;BookingConfirmation&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p><code>log_metrics</code> decorator <strong>validates</strong>, <strong>serializes</strong>, and <strong>flushes</strong> all your metrics. During metrics validation, if no metrics are provided then a warning will be logged, but no exception will be raised.</p>
<p>If metrics are provided, and any of the following criteria are not met, <code>SchemaValidationError</code> exception will be raised:</p>
<ul>
<li>Minimum of 1 dimension</li>
<li>Maximum of 9 dimensions</li>
<li>Namespace is set, and no more than one</li>
<li>Metric units must be <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_MetricDatum.html">supported by CloudWatch</a></li>
</ul>
<p>If you want to ensure that at least one metric is emitted, you can pass <code>raise_on_empty_metrics</code> to the <strong>log_metrics</strong> decorator:</p>
<div class="tabbed-set" data-tabs="7:1"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><label for="__tabbed_7_1">lambda_handler.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">Metrics</span>

<span class="hll"><span class="nd">@metrics</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">raise_on_empty_metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># highlight-line</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you expect your function to execute without publishing metrics every time, you can suppress the warning with <strong><code>warnings.filterwarnings("ignore", "No metrics to publish*")</code></strong>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When nesting multiple middlewares, you should use <strong><code>log_metrics</code> as your last decorator wrapping all subsequent ones</strong>.</p>
</div>
<div class="tabbed-set" data-tabs="8:1"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><label for="__tabbed_8_1">lambda_handler_nested_middlewares.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;ExampleApplication&quot;</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;booking&quot;</span><span class="p">)</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ColdStart&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="hll"><span class="nd">@metrics</span><span class="o">.</span><span class="n">log_metrics</span>
</span><span class="hll"><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;BookingConfirmation&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h2 id="flushing-metrics-manually">Flushing metrics manually</h2>
<p>If you prefer not to use <code>log_metrics</code> because you might want to encapsulate additional logic when doing so, you can manually flush and clear metrics as follows:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Metrics, dimensions and namespace validation still applies.</p>
</div>
<div class="tabbed-set" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><label for="__tabbed_9_1">manual_metric_serialization.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;ExampleApplication&quot;</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s2">&quot;booking&quot;</span><span class="p">)</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ColdStart&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="hll"><span class="n">your_metrics_object</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">serialize_metric_set</span><span class="p">()</span>
</span><span class="hll"><span class="n">metrics</span><span class="o">.</span><span class="n">clear_metrics</span><span class="p">()</span>
</span><span class="hll"><span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">your_metrics_object</span><span class="p">))</span>
</span></code></pre></div>
</td></tr></table>
</div>
</div>
<h2 id="capturing-cold-start-metric">Capturing cold start metric</h2>
<p>You can capture cold start metrics automatically with <code>log_metrics</code> via <code>capture_cold_start_metric</code> param.</p>
<div class="tabbed-set" data-tabs="10:1"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><label for="__tabbed_10_1">lambda_handler.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="s2">&quot;ExampleService&quot;</span><span class="p">)</span>

<span class="hll"><span class="nd">@metrics</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">capture_cold_start_metric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>If it's a cold start invocation, this feature will:</p>
<ul>
<li>Create a separate EMF blob solely containing a metric named <code>ColdStart</code></li>
<li>Add <code>function_name</code> and <code>service</code> dimensions</li>
</ul>
<p>This has the advantage of keeping cold start metric separate from your application metrics.</p>
<h2 id="testing-your-code">Testing your code</h2>
<h3 id="environment-variables">Environment variables</h3>
<p>Use <code>POWERTOOLS_METRICS_NAMESPACE</code> and <code>POWERTOOLS_SERVICE_NAME</code> env vars when unit testing your code to ensure metric namespace and dimension objects are created, and your code doesn't fail validation.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nv">POWERTOOLS_SERVICE_NAME</span><span class="o">=</span><span class="s2">&quot;Example&quot;</span> <span class="nv">POWERTOOLS_METRICS_NAMESPACE</span><span class="o">=</span><span class="s2">&quot;Application&quot;</span> python -m pytest
</code></pre></div>
</td></tr></table>
<p>If you prefer setting environment variable for specific tests, and are using Pytest, you can use <a href="https://docs.pytest.org/en/latest/monkeypatch.html">monkeypatch</a> fixture:</p>
<div class="tabbed-set" data-tabs="11:1"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><label for="__tabbed_11_1">pytest_env_var.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_namespace_env_var</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="c1"># Set POWERTOOLS_METRICS_NAMESPACE before initializating Metrics</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;POWERTOOLS_METRICS_NAMESPACE&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>

    <span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">()</span>
    <span class="o">...</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<blockquote>
<p>Ignore this, if you are explicitly setting namespace/default dimension via <code>namespace</code> and <code>service</code> parameters: <code>metrics = Metrics(namespace=ApplicationName, service=ServiceName)</code></p>
</blockquote>
<h3 id="clearing-metrics">Clearing metrics</h3>
<p><code>Metrics</code> keep metrics in memory across multiple instances. If you need to test this behaviour, you can use the following Pytest fixture to ensure metrics are reset incl. cold start:</p>
<div class="tabbed-set" data-tabs="12:1"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><label for="__tabbed_12_1">pytest_metrics_reset_fixture.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reset_metric_set</span><span class="p">():</span>
    <span class="c1"># Clear out every metric data prior to every test</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">()</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">clear_metrics</span><span class="p">()</span>
    <span class="n">metrics_global</span><span class="o">.</span><span class="n">is_cold_start</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># ensure each test has cold start</span>
    <span class="k">yield</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../logger/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Logger
              </div>
            </div>
          </a>
        
        
          <a href="../../utilities/middleware_factory/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Middleware factory
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.53cc9318.min.js"></script>
      <script src="../../assets/javascripts/bundle.e9c9f54f.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ['navigation.sections'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
      
        <script src="../../javascripts/config.js"></script>
      
    
  </body>
</html>